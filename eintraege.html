
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Einträge durchsuchen</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; }
    .filters { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .filters > div { flex: 1 1 200px; }
    .results-info { margin-bottom: 1rem; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #f4f4f4; cursor: pointer; }
    .pagination { margin-top: 1rem; }
    @media print {
      body { margin: 0; }
      .filters, .pagination, .results-info, .search-btn { display: none; }
      table { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <h1>Einträge durchsuchen</h1>
  <div class="filters">
    <div><label for="gipfel">Gipfel:</label><select id="gipfel" onchange="updateFilterOptions()"></select></div>
    <div><label for="route">Route:</label><select id="route" onchange="updateFilterOptions()"></select></div>
    <div><label for="buch">Buch:</label><select id="buch" onchange="updateFilterOptions()"></select></div>
    <div><label for="erstbegehung">Erstbegehung:</label>
      <select id="erstbegehung" onchange="updateFilterOptions()">
        <option value="">Alle</option><option value="Ja">Ja</option><option value="Nein">Nein</option>
      </select>
    </div>
    <div><label for="jahrVon">Jahr von:</label><input type="number" id="jahrVon" min="1900" max="2100" onchange="updateFilterOptions()" /></div>
    <div><label for="jahrBis">Jahr bis:</label><input type="number" id="jahrBis" min="1900" max="2100" onchange="updateFilterOptions()" /></div>
    <div><label for="wer">Wer:</label><input type="text" id="wer" /></div>
    <div><label for="notiz">Notiz:</label><input type="text" id="notiz" /></div>
    <div style="align-self: flex-end;"><button class="search-btn" onclick="loadEntries()">Suchen</button></div>
  </div>
  <div class="results-info" id="results-info">Bitte Filter setzen und "Suchen" klicken.</div>
  <table id="results-table">
    <thead>
      <tr>
        <th onclick="sortTable('Datum_JMT')">Datum</th>
        <th onclick="sortTable('Gipfel')">Gipfel</th>
        <th onclick="sortTable('Route')">Route</th>
        <th onclick="sortTable('Wer')">Wer</th>
        <th onclick="sortTable('Buch')">Buch</th>
        <th onclick="sortTable('Erstbegehung')">Erstbegehung</th>
        <th onclick="sortTable('Notiz')">Notiz</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="pagination" id="pagination"></div>
  <script>
    let currentEntries = [];
    let currentSort = { field: null, asc: true };
    function updateFilterOptions() {
      const params = new URLSearchParams({
        gipfel: gipfel.value, route: route.value, buch: buch.value,
        erstbegehung: erstbegehung.value, jahrVon: jahrVon.value, jahrBis: jahrBis.value
      });
      fetch(`https://alpsteindb.onrender.com/api/filter-options?${params}`)
        .then(res => res.json())
        .then(data => {
          updateSelect("gipfel", data.gipfel);
          updateSelect("route", data.route);
          updateSelect("buch", data.buch);
        });
    }
    function updateSelect(id, options) {
      const s = document.getElementById(id), cur = s.value;
      s.innerHTML = `<option value="">Alle</option>` + options.map(opt => `<option value="${opt}" ${opt===cur?'selected':''}>${opt}</option>`).join("");
    }
    function loadEntries(page = 1, limit = 10) {
      const params = new URLSearchParams({
        gipfel: gipfel.value, route: route.value, buch: buch.value,
        erstbegehung: erstbegehung.value, jahrVon: jahrVon.value, jahrBis: jahrBis.value,
        wer: wer.value, notiz: notiz.value, page, limit
      });
      resultsInfo.textContent = "Lade Einträge...";
      fetch(`https://alpsteindb.onrender.com/api/eintraege?${params}`)
        .then(res => res.json())
        .then(data => {
          currentEntries = data.entries;
          renderTable(currentEntries);
          resultsInfo.textContent = data.total > 1000 ? "Mehr als 1'000 Einträge gefunden – bitte Filter verfeinern." : `${data.total} Einträge gefunden.`;
          renderPagination(data.total, page, limit);
        });
    }
    function renderTable(entries) {
      const tbody = document.querySelector('#results-table tbody');
      tbody.innerHTML = "";
      entries.forEach(e => {
        tbody.innerHTML += `<tr>
          <td>${e.Datum_JMT||''}</td><td>${e.Gipfel||''}</td><td>${e.Route||''}</td>
          <td>${e.Wer||''}</td><td>${e.Buch||''}</td><td>${e.Erstbegehung||''}</td><td>${e.Notiz||''}</td>
        </tr>`;
      });
    }
    function sortTable(field) {
      currentSort.asc = currentSort.field === field ? !currentSort.asc : true;
      currentSort.field = field;
      currentEntries.sort((a, b) => {
        const A = a[field]||'', B = b[field]||'';
        return currentSort.asc ? A.localeCompare(B) : B.localeCompare(A);
      });
      renderTable(currentEntries);
    }
    function renderPagination(total, page, limit) {
      const pages = Math.min(Math.ceil(total/limit), 100);
      pagination.innerHTML = `Seite ${page} von ${pages} | ` +
        Array.from({length: pages}, (_,i)=>`<button onclick="loadEntries(${i+1},${limit})">${i+1}</button>`).join(' ') +
        ` | Zeige pro Seite: <select onchange="loadEntries(1,this.value)">
        <option value="10">10</option><option value="20">20</option>
        <option value="50">50</option><option value="100">100</option></select>`;
    }
    window.addEventListener("DOMContentLoaded", updateFilterOptions);
  </script>
</body>
</html>
