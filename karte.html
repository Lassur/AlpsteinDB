
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Karte ‚Äì AlpsteinDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 80vh; margin-bottom: 1rem; }
    .topbar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .filterbar label {
      margin-right: 0.5rem;
    }
    .legend {
      font-size: 0.9rem;
      margin-left: 1rem;
      margin-right: 1rem;
    }
    .legend span {
      display: inline-block;
      width: 1em;
      height: 1em;
      border-radius: 50%;
      margin-right: 0.5em;
      vertical-align: middle;
    }
    #statistik {
      font-size: 0.9rem;
      color: #333;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <nav>
      <a href="index.html">Home</a>
      <a href="eintraege.html">Eintr√§ge</a>
      <a href="charts.html">Charts</a>
      <a href="buecher.html">B√ºcher</a>
      <a href="karte.html" class="active">Karte</a>
    </nav>

    <h1>Gipfelkarte</h1>

    <div class="topbar">
      <div class="legend">
        <strong>Legende:</strong><br>
        <span style="background:gray;"></span> Keine Eintr√§ge<br>
        <span style="background:green;"></span> Eintr√§ge vorhanden
      </div>
	  
	  <div class="filterbar">
        <label for="jahrFilter">Jahr:</label>
        <select id="jahrFilter"><option value="">Alle</option></select>
        <label for="monatFilter" style="margin-left:1rem;">Monat:</label>
        <select id="monatFilter"><option value="">Alle</option></select>
      </div>

      <div id="statistik">
        Gefundene Gipfel mit Eintr√§gen: 0<br>
        Gesamte Eintr√§ge: 0
      </div>
    </div>

    <div id="map"></div>

    <footer style="text-align:center; font-size: 0.8rem; color: #666;">
      ¬© Andreas Koller, 2025 ‚Äì <a href="mailto:andreas-koller@gmx.ch">andreas-koller@gmx.ch</a>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
const map = L.map('map').setView([47.25, 9.35], 12);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

let markers = [];

function getColor(count) {
  if (count === 0) return "gray";
  if (count < 50) return "#b7efc5";       // hellgr√ºn
  if (count < 200) return "#4caf50";       // gr√ºn
  if (count < 1000) return "#087f23";      // dunkelgr√ºn
  return "#004d00";                       // sehr dunkelgr√ºn
}

async function loadData() {
  const [mapData, tableData] = await Promise.all([
    fetch('maphttps://storage.googleapis.com/alpsteindb/data.json').then(res => res.json()),
    fetch('https://storage.googleapis.com/alpsteindb/data.json').then(res => res.json())
  ]);

  const jahrSel = document.getElementById("jahrFilter");
  const monatSel = document.getElementById("monatFilter");

  const jahre = [...new Set(tableData.map(e => e.Jahr).filter(Boolean))].sort();
  const monate = [...new Set(tableData.map(e => e.Monat).filter(Boolean))].sort((a, b) => a - b);

  jahre.forEach(y => jahrSel.innerHTML += `<option value="${y}">${y}</option>`);
  monate.forEach(m => monatSel.innerHTML += `<option value="${m}">${String(m).padStart(2, "0")}</option>`);

  function renderMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    const jFilter = jahrSel.value;
    const mFilter = monatSel.value;

    const gefiltert = tableData.filter(e =>
      (!jFilter || e.Jahr == jFilter) &&
      (!mFilter || String(e.Monat).padStart(2, "0") == mFilter)
    );

    const counter = {};
    gefiltert.forEach(e => {
      if (e.Gipfel) counter[e.Gipfel] = (counter[e.Gipfel] || 0) + 1;
    });

    const circles = mapData.map(g => {
      const count = counter[g.Gipfel] || 0;
      const size = count > 0 ? Math.min(30, 6 + count / 50) : 6;
      return { ...g, count, size };
    });

    // üÜï Statistik berechnen:
    const totalGipfel = circles.filter(g => g.count > 0).length;
    const totalEintraege = circles.reduce((sum, g) => sum + g.count, 0);
    document.getElementById('statistik').innerHTML = `
      Gefundene Gipfel mit Eintr√§gen: ${totalGipfel}<br>
      Gesamte Eintr√§ge: ${totalEintraege}
    `;

    circles.sort((a, b) => b.size - a.size); // gro√üe zuerst

    circles.forEach(g => {
      const color = getColor(g.count);
      const circle = L.circleMarker([g.lat, g.lng], {
        radius: 0,  // Start bei 0 f√ºr Animation
        color,
        fillColor: color,
        fillOpacity: 0.5,
        weight: 1
      }).addTo(map);

      circle.bindPopup(`
        <strong><a href="eintraege.html?gipfel=${encodeURIComponent(g.Gipfel)}">${g.Gipfel}</a></strong><br>
        ${g.count} Eintr√§ge
      `);

      // Sanfte Wachstumsanimation
      let currentSize = 0;
      const targetSize = g.size;
      const steps = 10;
      const interval = setInterval(() => {
        currentSize += targetSize / steps;
        circle.setRadius(currentSize);
        if (currentSize >= targetSize) {
          clearInterval(interval);
          circle.setRadius(targetSize);
        }
      }, 20);

      markers.push(circle);
    });
  }

  jahrSel.addEventListener("change", renderMarkers);
  monatSel.addEventListener("change", renderMarkers);

  renderMarkers();
}

loadData();
</script>

</body>
</html>
